# 資料庫模組 (Database Module)

提供 Supabase 資料庫連接和 ASIN 相關的查詢功能，支援單例模式連接管理與完整的錯誤處理機制。

## 🚀 快速開始

### 基本使用流程

1. **ASIN 狀態管理**：智能篩選需要抓取的 ASIN 並管理任務狀態
2. **產品資料管理**：進行產品資料的增刪改查操作
3. **快照資料追蹤**：管理產品的時間序列資料
4. **告警系統管理**：管理告警規則和記錄異常變化
5. **報告任務管理**：管理競品分析報告的生成和存儲

## 📁 目錄結構

```
shared/database/
├── __init__.py              # 模組初始化與公開 API
├── supabase_client.py       # Supabase 客戶端（單例模式）
├── asin_status_queries.py   # ASIN 狀態查詢與任務分發
├── products_queries.py      # 產品資料 CRUD 操作
├── snapshots_queries.py     # 產品快照時間序列資料
├── alert_queries.py         # 告警規則和記錄管理
├── report_queries.py        # 報告任務和結果管理
├── example_usage.py         # 使用範例
├── tests/                   # 單元測試
│   ├── __init__.py
│   └── test_supabase_client.py
└── README.md               # 本檔案
```

## 📋 核心功能

### Supabase 客戶端 (`supabase_client.py`)

提供統一的資料庫連接管理，採用單例模式確保全應用只使用一個資料庫連接。包含配置驗證和連接測試功能。

### ASIN 狀態查詢 (`asin_status_queries.py`)

**功能描述：**
ASIN 狀態查詢模組負責管理 ASIN 任務的完整生命週期，從任務創建到完成的全過程追蹤。它能夠智能識別需要抓取的 ASIN，並提供高效的批量狀態更新功能。

**主要特點：**
- **智能任務篩選**：自動識別新任務、過期任務、超時任務和可重試任務
- **批量狀態管理**：支援高效的批量狀態更新操作
- **狀態轉換控制**：管理 pending → running → completed/failed 的狀態流程
- **超時檢測機制**：自動檢測和處理超時任務
- **重試機制**：支援失敗任務的自動重試（最多3次）

**核心功能：**
- 根據多種條件智能篩選需要抓取的 ASIN
- 批量更新 ASIN 狀態，支援部分成功/失敗的結果處理
- 自動記錄任務時間戳記和重試次數
- 提供錯誤回退機制，確保資料一致性

**狀態管理流程：**
1. 系統啟動時識別需要處理的 ASIN 任務
2. 任務開始時將狀態更新為 running 並記錄時間戳記
3. 任務完成時更新為 completed 狀態
4. 任務失敗時更新為 failed 狀態並增加重試次數
5. 超時任務自動重新排入佇列等待處理

### 產品資料管理 (`products_queries.py`)

**功能描述：**
產品資料管理模組提供完整的產品資料 CRUD 操作，支援單筆和批量處理。它能夠安全地處理產品資料的創建、更新、查詢和刪除操作，並確保資料的一致性和完整性。

**主要特點：**
- **完整 CRUD 支援**：提供創建、讀取、更新、刪除的完整操作
- **批量處理**：支援高效的批量資料操作
- **資料驗證**：自動進行資料驗證和清理
- **Upsert 操作**：避免重複插入，確保資料唯一性
- **類型安全**：提供完整的類型提示和資料驗證

**核心功能：**
- 根據 ASIN 查詢單個或多個產品資料
- 批量創建和更新產品資料
- 安全的資料插入和更新操作
- 支援產品資料的結構化查詢

### 快照資料追蹤 (`snapshots_queries.py`)

**功能描述：**
快照資料追蹤模組負責管理產品的時間序列資料，記錄產品在不同時間點的狀態變化。它提供強大的歷史資料查詢功能，支援趨勢分析和歷史回顧。

**主要特點：**
- **時間序列管理**：記錄產品在不同時間點的完整狀態
- **靈活查詢**：支援按日期範圍、產品等多種條件查詢
- **批量操作**：高效的批量快照創建和更新
- **歷史分析**：提供豐富的歷史資料分析功能

**核心功能：**
- 按日期範圍查詢產品歷史快照
- 支援多產品同時查詢
- 批量創建和更新快照資料
- 提供最新快照和歷史快照的對比分析

### 告警系統管理 (`alert_queries.py`)

**功能描述：**
告警系統管理模組負責監控產品資料的異常變化，提供靈活的告警規則配置和自動化的告警觸發機制。它能夠根據設定的規則自動檢測價格、評分、排名等關鍵指標的變化，並及時發出告警通知。

**主要特點：**
- **靈活規則配置**：支援多種告警規則類型和變化方向設定
- **自動化監控**：在資料更新時自動檢查告警條件
- **高效查詢**：透過 Redis 快取提升告警規則查詢效能
- **完整記錄**：詳細記錄所有觸發的告警事件
- **模組整合**：與快照查詢模組深度整合

**告警規則類型：**
- **價格變化告警**：監控產品價格的異常波動
- **BSR 排名變化告警**：追蹤產品在 Amazon 的排名變化
- **評分變化告警**：監控產品評分的顯著變化

**變化方向設定：**
- **上升告警**：當數值增加超過閾值時觸發
- **下降告警**：當數值減少超過閾值時觸發
- **雙向告警**：當數值變化（無論方向）超過閾值時觸發

**核心功能：**
- 從資料庫獲取啟用的告警規則
- 創建和記錄觸發的告警事件
- 與快照查詢模組整合獲取歷史資料
- 透過 Redis 快取提升查詢效能

**告警檢查流程：**
1. 系統在處理產品資料更新時自動觸發告警檢查
2. 從 Redis 快取中獲取啟用的告警規則
3. 比較當前資料與歷史資料的變化
4. 根據規則條件判斷是否觸發告警
5. 記錄告警事件並可選擇發送通知

### 報告任務管理 (`report_queries.py`)

**功能描述：**
報告任務管理模組負責管理競品分析報告的完整生命週期，從任務創建到結果存儲的全過程。它提供強大的任務狀態追蹤、冪等性控制和結果管理功能，確保報告生成的可靠性和效率。

**主要特點：**
- **完整生命週期管理**：從任務創建到完成的全過程追蹤
- **冪等性控制**：基於參數雜湊值避免重複生成相同報告
- **狀態追蹤**：詳細的任務狀態管理和錯誤處理
- **結果存儲**：安全的報告結果存儲和查詢
- **高效查詢**：支援快速查詢任務狀態和結果

**任務狀態流程：**
- **pending**：初始狀態，等待系統處理
- **running**：正在執行中，LLM 生成報告階段
- **completed**：成功完成，報告生成並存儲完成
- **failed**：執行失敗，記錄錯誤信息供後續處理

**冪等性設計：**
- 基於請求參數生成唯一的 SHA-256 雜湊值
- 同一天內相同參數的請求直接返回已生成的報告
- 有效避免重複生成相同內容的報告，節省資源

**核心功能：**
- 創建和管理報告生成任務
- 追蹤任務執行狀態和進度
- 存儲和查詢報告結果內容
- 提供冪等性檢查避免重複處理
- 支援任務狀態的實時查詢

**資料管理：**
- 使用 `report_jobs` 表管理任務狀態和元資料
- 使用 `report_results` 表存儲報告內容和結果
- 支援大容量報告內容的安全存儲

## 🗄️ 資料庫結構

### 核心資料表

系統使用七個主要資料表來管理完整的電商監控和分析功能：

1. **`asin_status`**：管理 ASIN 任務狀態和排程，追蹤每個產品的處理進度
2. **`products`**：儲存產品基本資訊，包括標題、分類、品牌等核心資料
3. **`product_snapshots`**：記錄產品的時間序列資料，追蹤價格、評分、排名等變化
4. **`report_jobs`**：管理報告生成任務的狀態和元資料
5. **`report_results`**：存儲生成的報告內容和結果
6. **`alert_rules`**：配置告警規則，支援動態管理和調整
7. **`alerts`**：記錄觸發的異常告警事件

### 任務狀態管理

**ASIN 任務狀態流程：**
- **pending**：初始狀態，等待系統處理
- **running**：正在執行中，任務已啟動並記錄時間戳記
- **completed**：成功完成，資料已成功抓取並處理
- **failed**：執行失敗，記錄錯誤信息並可重試（最多3次）

**超時處理機制：**
系統會自動檢測超過 5 分鐘的 running 任務，將其重新排入佇列等待重新處理，確保任務不會永久卡住。
